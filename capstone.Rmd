---
title: "Predicting Pitcher DL"
author: "Roger Chow"
date: "February 20, 2017"
output: word_document
---

```{r setup}
setwd("F:/Capstone_Workspace/predictDL");
library('RODBC');
library('DBI');
library('dplyr');
library('ggplot2');
library('stringi');
library('sqldf');
library('corrplot');
library('reshape2');
library('ggplot2');
library('caret');
```

```{r pitch from database}
dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost;database=PitchFx;trusted_connection=true');
query <-
'SELECT	m.rsid, min(ms.nameLast) as nameLast, min(ms.nameFirst) as nameFirst,
		year(p.GameDate) as season, 
		avg(p.x) as x, 
		avg(p.y) as y, 
		avg(p.start_speed) as start_speed, 
		avg(p.end_speed) as end_speed, 
		avg(p.sz_top) as sz_top,
		avg(p.sz_bot) as sz_bot,
		avg(p.pfx_x) as pfx_x, 
		avg(p.pfx_z) as pfx_z,
		avg(p.px) as px, 
		avg(p.pz) as pz,
		avg(p.x0) as x0, 
		avg(p.y0) as y0, 
		avg(p.z0) as z0,
		avg(p.vx0) as vx0, 
		avg(p.vy0) as vy0, 
		avg(p.vz0) as vz0,
		avg(p.ax) as ax, 
		avg(p.ay) as ay, 
		avg(p.az) as az,
		avg(p.break_y) as break_y, 
		avg(p.break_angle) as break_angle, 
		avg(p.break_length) as break_length,
		avg(p.spin_dir) as spin_dir, 
		avg(p.spin_rate) as spin_rate,
		sum(p.num_pitches) as num_pitches
  FROM [PitchFx].[dbo].[GamesAtBatsAggregatePitches] p
  INNER JOIN [Mapping].[dbo].[RSID_MLBID_MAP] m on p.pitcher = m.mlbid
  INNER JOIN [Lahman].[dbo].[Master] ms on ms.retroID = m.rsID
  GROUP BY m.rsid, year(p.GameDate)'

pitches <- sqlQuery(dbhandle, query);
pitches <- pitches[complete.cases(pitches),];
close(dbhandle);
```

```{r disabled list}
dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost;database=PitchFx;trusted_connection=true');
query <- " 
SELECT rsid, 2011 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2011]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2012 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2012]
  WHERE Pos in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2013 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2013]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2014 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2014]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2015 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2015]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2016 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2016]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
";

dl <- sqlQuery(dbhandle, query);
dl <- dl[complete.cases(dl),];
dl$season_1 <- dl$season-1;
close(dbhandle);

```


```{r merge pitches to disabled list}

#use previous season to predict DL in current season
pitches_dl <- merge(x=pitches, y=dl, by.x=c("rsid", "season"), by.y=c("rsid", "season_1"), all.x = TRUE, all.y=FALSE)

pitches_dl[pitches_dl==""] <- NA; #replace blanks with NA

pitches_dl$DLDays[is.na(pitches_dl$DLDays)] <- 0; #no DL pitchers are on DL for 0 days

drops <- c("season_dl");
pitches_dl <- pitches_dl[ , !(names(pitches_dl) %in% drops)];

pitches_dl <- pitches_dl[complete.cases(pitches_dl),];

pitches_dl_dataset <- pitches_dl[pitches_dl$season < 2016,]; #for modeling
pitches_dl_predict <- pitches_dl[pitches_dl$season == 2016,]; #for 2017 prediction

pitches_dl_dataset$OnDL <- as.factor(ifelse(pitches_dl_dataset$DLDays>0, 'YES', 'NO'));

```


```{r pitch summary}
summary(pitches_dl_dataset);

```

```{r pitch correlation}
numeric_dataset <- pitches_dl_dataset[sapply(pitches_dl_dataset, is.numeric)];
#exclude season and DLDays
numeric_dataset <- numeric_dataset[2:(ncol(numeric_dataset)-1)];
m <- cor(numeric_dataset);
corrplot(m);
```
```{r highly pitch correlation}
highlyCorrelated <- findCorrelation(m, cutoff=0.5);
lowCorrelatedCols <- colnames(numeric_dataset[-highlyCorrelated]);
print(lowCorrelatedCols);

```

```{r histogram}
d <- melt(pitches_dl_dataset[sapply(pitches_dl_dataset, is.numeric)]);

ggplot(d,aes(x = value)) + facet_wrap(~variable,scales = "free_x") +  geom_histogram();

```

```{r qq plot for normality}
par(mar=c(2,2,2,2))
#for (i in 5:ncol(pitches_dl_dataset[,1: ncol(pitches_dl_dataset) - 1 ])){  
for (i in 5:(ncol(pitches_dl_dataset)-2)){  
  tmp <- pitches_dl_dataset[, i];
  qqnorm(tmp, main = colnames(pitches_dl_dataset[i]));
  qqline(tmp);
}
```

```{r training and testing data set}
train <- createDataPartition(pitches_dl_dataset$OnDL, p=0.65, list=FALSE);
training <- pitches_dl_dataset[train,];
testing <- pitches_dl_dataset[-train,];
```

```{r caret model}
selected_variables <-lowCorrelatedCols; #c('x', 'start_speed', 'y0', 'break_y', 'spin_dir', 'spin_rate');

selected_i <- which(colnames(pitches_dl_dataset) %in%selected_variables);
  
formula_text <- paste(names(pitches_dl_dataset)[ncol(pitches_dl_dataset)], "~",
                      paste(names(pitches_dl_dataset)[selected_i], collapse="+"));
formula <- as.formula(formula_text);

mod_fit <- train(formula,  data=training, method="glm", family="binomial");
summary(mod_fit);

```

```{r coefficients of model}

coef(mod_fit$finalModel);

```

```{r evaluation}
pred <- predict(mod_fit, newdata=testing);
confusionMatrix(data=pred, reference=testing$OnDL);
```
```{r significant varables}
formula <- as.formula('OnDL ~ y + x0 + spin_dir + spin_rate + num_pitches');

mod_fit <- train(formula,  data=training, method="glm", family="binomial");
summary(mod_fit);

```

```{r coefficients of model}

coef(mod_fit$finalModel);

```

```{r evaluation}
pred <- predict(mod_fit, newdata=testing);
confusionMatrix(data=pred, reference=testing$OnDL);
```

```{r predictions for 2017}
prediction <- predict(mod_fit, newdata=pitches_dl_predict, type='prob');
prediction <- cbind(pitches_dl_predict, prediction);

prediction_df <- as.data.frame(prediction);
prediction_df <- prediction_df[order(prediction_df$YES, decreasing = TRUE),];
head(prediction_df[c('nameFirst', 'nameLast', 'num_pitches', 'YES')]);
```


```{r logisic regression with GLM }
selected_variables <- lowCorrelatedCols; #c('x', 'start_speed', 'y0', 'break_y', 'spin_dir','num_pitches');

selected_i <- which(colnames(pitches_dl_dataset) %in% selected_variables);
  
formula_text <- paste(names(pitches_dl_dataset)[ncol(pitches_dl_dataset)], "~",
                      paste(names(pitches_dl_dataset)[selected_i], collapse="+"));
formula <- as.formula(formula_text);

mod_1 = glm(formula = formula , family=binomial(logit), data=training);
summary(mod_1);


```


```{r evaluation}
pred <- ifelse(predict(mod_1, testing, type='response') > 0.5, 'YES', 'NO')
confusionMatrix(data=pred, reference=testing$OnDL);
```

```{r nothing model}
formula_text <- paste(names(training)[ncol(training)], "~1");
formula <- as.formula(formula_text);


mod_nothing = glm(formula = formula , family=binomial(logit), data=training);

summary(mod_nothing);
```



```{r backaward selection (TO DO)}
backward <- step(glm.out); 

summary(backwards);
```



```{r forward selection (TO DO)}
forward <- step(glm.out, direction = "forward"); 

summary(forward);
```