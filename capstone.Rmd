---
title: "Predicting Pitcher DL"
author: "Roger Chow"
date: "February 20, 2017"
output: word_document
---

```{r setup}
setwd("F:/Capstone_Workspace/predictDL");
library('RODBC');
library('DBI');
library('dplyr');
library('ggplot2');
library('stringi');
library('sqldf');
library('corrplot');
library('reshape2');
library('ggplot2');
```

```{r pitch from database}
dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost;database=PitchFx;trusted_connection=true');
query <-
'SELECT	m.rsid, 
		year(p.GameDate) as season, 
		avg(p.x) as x, 
		avg(p.y) as y, 
		avg(p.start_speed) as start_speed, 
		avg(p.end_speed) as end_speed, 
		avg(p.sz_top) as sz_top,
		avg(p.sz_bot) as sz_bot,
		avg(p.pfx_x) as pfx_x, 
		avg(p.pfx_z) as pfx_z,
		avg(p.px) as px, 
		avg(p.pz) as pz,
		avg(p.x0) as x0, 
		avg(p.y0) as y0, 
		avg(p.z0) as z0,
		avg(p.vx0) as vx0, 
		avg(p.vy0) as vy0, 
		avg(p.vz0) as vz0,
		avg(p.ax) as ax, 
		avg(p.ay) as ay, 
		avg(p.az) as az,
		avg(p.break_y) as break_y, 
		avg(p.break_angle) as break_angle, 
		avg(p.break_length) as break_length,
		avg(p.spin_dir) as spin_dir, 
		avg(p.spin_rate) as spin_rate,
		sum(p.num_pitches) as num_pitches
  FROM [PitchFx].[dbo].[GamesAtBatsAggregatePitches] p
  INNER JOIN [Mapping].[dbo].[RSID_MLBID_MAP] m on p.pitcher = m.mlbid
  GROUP BY m.rsid, year(p.GameDate)'

pitches <- sqlQuery(dbhandle, query);
pitches <- pitches[complete.cases(pitches),];

```

```{r disabled list}
dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost;database=PitchFx;trusted_connection=true');
query <- " 
SELECT rsid, 2011 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2011]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2012 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2012]
  WHERE Pos in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2013 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2013]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2014 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2014]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2015 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2015]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
UNION
SELECT rsid, 2016 as season_dl, sum(days) as DLDays
  FROM [DisabledList].[dbo].[DL2016]
  WHERE Position in ('LHP','RHP','RP','SP','P')
  GROUP BY rsid
";

dl <- sqlQuery(dbhandle, query);
dl <- dl[complete.cases(dl),];
dl$season_1 <- dl$season-1;

```


```{r merge pitches to disabled list}

pitches_dl <- merge(x=pitches, y=dl, by.x=c("rsid", "season"), by.y=c("rsid", "season_1"), all.x = TRUE, all.y=FALSE)

pitches_dl[pitches_dl==""] <- NA; #replace blanks with NA

pitches_dl$DLDays[is.na(pitches_dl$DLDays)] <- 0; #no DL pitchers are on DL for 0 days

drops <- c("season_dl");
pitches_dl <- pitches_dl[ , !(names(pitches_dl) %in% drops)];

pitches_dl <- pitches_dl[complete.cases(pitches_dl),];
```


```{r pitch summary}
summary(pitches_dl);

```

```{r pitch correlation}
m <- cor(pitches_dl[sapply(pitches_dl, is.numeric)]);
corrplot(m);
```


```{r histogram}
d <- melt(pitches_dl[sapply(pitches_dl, is.numeric)]);

ggplot(d,aes(x = value)) + 
    facet_wrap(~variable,scales = "free_x") + 
    geom_histogram();

```

```{r lahmans database}
pitching <- read.csv("data/baseballdatabank-2017.1/core/Pitching.csv", header=TRUE);
master <- read.csv("data/baseballdatabank-2017.1/core/Master.csv", header =TRUE);
salaries <- read.csv("data/baseballdatabank-2017.1/core/Salaries.csv", header =TRUE);

#only players pitching between 2010 and 2016 and aggregate stats by playerID and year
pitching <- pitching %>%
  filter(yearID >= 2009 & yearID <= 2016) %>%
  select(playerID,yearID,W,L,G,GS,CG,SHO,SV,IPouts,H,ER,HR,BB,SO,WP,HBP,BK,BFP,GF,R,SH,SF,G) %>%
  group_by(playerID, yearID) %>%
  summarise(
    totallW = sum(W),
    totalL = sum(L),
    totalG = sum(G),
    totalGS = sum(GS),
    totalCG = sum(CG),
    totalSHO = sum(SHO),
    totalSV = sum(SV),
    totalIPouts = sum(IPouts),
    totalH = sum(H),
    totalER = sum(ER),
    totalHR = sum(HR),
    totalBB = sum(BB),
    totalSO = sum(SO),
    totalWP = sum(WP),
    totalHBP = sum(HBP),
    totalBK = sum(BK),
    totalBFP = sum(BFP),
    totalGF = sum(GF),
    totalR = sum(R),
    totalSH = sum(SH),
    totalSF = sum(SF),
    totalG = sum(G))


pitching_master <- merge(x=pitching, y=master, by="playerID", all.x=TRUE);



```


```{r join disable list }

dl2010 <- read.csv("data/2010DL.csv", header=TRUE);
dl2010$Year <- format(as.Date(dl2010$Started, '%m/%d/%Y'), '%Y')

dl2010_Pitchers <- dl2010 %>% 
  filter(Pos == 'P' & TotalInSeasonDays > 0 & RSID != '') %>%
  select(RSID, Pos, First, Last, TotalInSeasonDays) %>%
  group_by(RSID, First, Last) %>%
  summarise(
    TotalDays2010 = sum(TotalInSeasonDays)
  )

#pitching_master_2009 <- pitching_master %>%
  # filter(yearID == 2009);


dl2010_Pitchers_Master <- merge(x=dl2010_Pitchers, y=master, by.x="RSID", by.y="retroID", all.x = TRUE, all.y=FALSE)


# pitching_master_dl_09_10 <- merge(x=pitching_master_2009, y=dl2010_Pitchers, by.x="retroID", by.y="RSID", all.x = TRUE, all.y=TRUE)

# write.csv(pitching_master_dl_09_10, file="pitching_master_dl_2009_2010.csv")


dl2011 <- read.csv("data/2011DL.csv", header=TRUE);
dl2011$Year <- format(as.Date(dl2011$Official.On.DL.Date, '%m/%d/%Y'), '%Y')

dl2011_Pitchers <- dl2011 %>% 
  filter((Position == 'RHP' | Position == 'LHP')  & Days > 0) %>%
  select(RSID, Position, First, Last, Days) %>%
  group_by(RSID, First, Last) %>%
  summarise(
    TotalDays2011 = sum(Days)
  )

dl2011_Pitchers_Master <- merge(x=dl2011_Pitchers, y=master, by.x="RSID", by.y="retroID", all.x = TRUE, all.y=FALSE)




dl2012 <- read.csv("data/2012DL.csv", header=TRUE);
dl2012$Year <- format(as.Date(dl2012$Dayon, '%m/%d/%Y'), '%Y')
dl2012_Pitchers <- dl2012 %>% 
  filter((Pos == 'RHP' | Pos == 'LHP')  & Days > 0) %>%
  select(First, Last, Pos, Days) %>%
  group_by(First, Last) %>%
  summarise(
    TotalDays2012 = sum(Days)
  )

dl2012_Pitchers_Master <- merge(x=dl2012_Pitchers, y=master, by.x=c("First", "Last"), by.y=c("nameFirst", "nameLast"), all.x = TRUE, all.y=FALSE)

write.csv(dl2012_Pitchers_Master, file="dl2012_Pitchers_Master.csv")
dl_Pitchers <- merge(x = dl2010_Pitchers, y=dl2011_Pitchers, by= "RSID", all=TRUE)

```